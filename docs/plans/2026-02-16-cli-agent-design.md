# Дизайн CLI Агента - День 1

**Дата:** 2026-02-16
**Цель:** Создать простой CLI агент для взаимодействия с LLM через OpenRouter API

## Обзор

CLI агент на TypeScript с использованием Ink (React для CLI), который позволяет пользователям вести диалог с LLM через OpenRouter API с сохранением контекста в рамках сессии.

## Требования

- Интерактивная REPL сессия с сохранением контекста
- Интеграция с OpenRouter API
- Реализация на TypeScript
- Конфигурация через .env файл
- Модульная архитектура для будущего расширения

## Архитектура

### Структура проекта

```
day1/
├── src/
│   ├── index.tsx              # Точка входа, запуск Ink приложения
│   ├── components/
│   │   └── Chat.tsx           # Главный React компонент для Ink
│   ├── api/
│   │   └── openrouter.ts      # Клиент для OpenRouter API
│   ├── chat/
│   │   └── conversation.ts    # Управление историей сообщений
│   └── types/
│       └── index.ts           # TypeScript типы
├── .env                       # Конфигурация (API ключ, модель)
├── .env.example              # Пример конфигурации
├── package.json
├── tsconfig.json
└── README.md
```

### Технологический стек

- **TypeScript** - типобезопасная разработка
- **Ink** - React для CLI рендеринга
- **dotenv** - управление переменными окружения
- **OpenRouter API** - доступ к LLM через fetch

## Компоненты

### Chat.tsx (Главный Ink компонент)

**Управление состоянием:**
- `messages: Message[]` - массив сообщений диалога
- `input: string` - текущий ввод пользователя
- `isLoading: boolean` - индикатор выполнения API запроса

**Функциональность:**
- Использует хук `useInput` от Ink для обработки ввода с клавиатуры
- Отправляет сообщение в API при нажатии Enter
- Отображает историю чата и поле ввода

**Визуальный макет:**
```
┌─────────────────────────────┐
│ User: Привет!               │
│ Assistant: Здравствуйте!    │
│                             │
│ User: Как дела?             │
│ Assistant: [загрузка...]    │
│                             │
│ > [ваш ввод]_               │
└─────────────────────────────┘
```

### openrouter.ts (API клиент)

**Основная функция:**
- `sendMessage(messages: Message[]): Promise<string>` - отправляет историю диалога в OpenRouter и возвращает ответ ассистента

**Конфигурация:**
- Читает `OPENROUTER_API_KEY` из .env
- Читает `OPENROUTER_MODEL` из .env для выбора модели

### conversation.ts (Управление историей)

**Функциональность:**
- Управляет операциями с массивом сообщений
- Методы:
  - `addUserMessage(content: string)`
  - `addAssistantMessage(content: string)`
  - `getHistory(): Message[]`

**Формат сообщения:**
```typescript
interface Message {
  role: 'user' | 'assistant';
  content: string;
}
```

## Поток данных

### Жизненный цикл запроса

1. **Ввод пользователя** → хук `useInput` от Ink перехватывает нажатия клавиш
2. **Нажатие Enter** →
   - Добавление сообщения пользователя в историю
   - Установка `isLoading = true`
   - Вызов `openrouter.sendMessage(history)`
3. **API запрос** →
   - Отправка всей истории сообщений в OpenRouter
   - Ожидание ответа
4. **Получение ответа** →
   - Добавление ответа ассистента в историю
   - Установка `isLoading = false`
   - Ink автоматически перерисовывает компонент
5. **Повтор** → Пользователь вводит следующее сообщение

### Формат OpenRouter API

```typescript
{
  model: process.env.OPENROUTER_MODEL,
  messages: [
    { role: "user", content: "Привет" },
    { role: "assistant", content: "Здравствуйте" },
    { role: "user", content: "Как дела?" }
  ]
}
```

**Управление контекстом:** Вся история передается при каждом запросе, что позволяет модели сохранять контекст диалога.

## Обработка ошибок

### Сценарии

1. **Отсутствие конфигурации:**
   - Проверка наличия .env файла и необходимых переменных при запуске
   - Вывод понятного сообщения: "Ошибка: не найден OPENROUTER_API_KEY в .env"
   - Завершение с кодом ошибки

2. **Ошибки API запросов:**
   - Сетевые ошибки (нет интернет-соединения)
   - 401 Unauthorized (неверный API ключ)
   - 429 Rate limit превышен
   - 500 Server errors
   - Отображение ошибки в UI: "Ошибка: [описание]"
   - Установка `isLoading = false`, возможность повтора

3. **Некорректный ответ API:**
   - Отсутствие ожидаемых полей в JSON
   - Вывод технической ошибки для отладки

### Реализация

- Блоки try/catch в `sendMessage()`
- Валидация `response.ok` в fetch вызовах
- Проверка переменных окружения при запуске

## Стратегия тестирования

### Основной подход: Ручное тестирование

**Тест-кейсы:**
- Приложение успешно запускается
- Отправка нескольких сообщений подряд
- Проверка сохранения контекста между сообщениями
- Тестирование сценариев с ошибками (неверный API ключ, отсутствие .env)

### Опциональные unit тесты (если будет время)

- Базовые тесты для `conversation.ts` (добавление/получение сообщений)
- Пропуск тестирования Ink компонентов в начальной версии

### Критерии готовности

- ✓ Приложение запускается без ошибок
- ✓ Пользователь может отправить сообщение и получить ответ
- ✓ Контекст сохраняется между сообщениями
- ✓ Ошибки отображаются понятно
- ✓ Можно выйти через Ctrl+C

## Будущие улучшения (не для Дня 1)

- Специальные команды (/clear, /exit, /help)
- Сохранение истории сообщений в файл
- Переключение модели во время сессии
- Потоковые ответы
- Улучшенное восстановление после ошибок

## Конфигурация

### Пример .env

```env
OPENROUTER_API_KEY=your_api_key_here
OPENROUTER_MODEL=anthropic/claude-3.5-sonnet
```

## Запуск

```bash
npm install
npm start
```
